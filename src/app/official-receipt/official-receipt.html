<div class="p-6">
  <!-- Top bar -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Official Receipts</h2>
    <button class="bg-blue-500 text-white px-4 py-2 rounded" (click)="openModal('add')">
      Add Receipt
    </button>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input type="text" [(ngModel)]="searchTerm" placeholder="Search receipts..."
      class="border px-3 py-2 rounded w-full" />
  </div>

  <!-- Receipts Table -->
  <table class="min-w-full bg-white border">
    <thead>
      <tr class="bg-gray-100 border-b">
        <th class="py-2 px-4 text-left">Customer</th>
        <th class="py-2 px-4 text-left">Branch</th>
        <th class="py-2 px-4 text-left">Receipt Number</th>
        <th class="py-2 px-4 text-left">Receipt Date</th>
        <th class="py-2 px-4 text-left">Amount</th>
        <th class="py-2 px-4 text-left">Note</th>
        <th class="py-2 px-4 text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let receipt of receipts | filter:searchTerm:'receipt_number' | slice:(currentPage-1)*pageSize:(currentPage)*pageSize"
        class="border-b">
        <td class="py-2 px-4">{{ getCustomerName(receipt.customer_id) }}</td>
        <td class="py-2 px-4">{{ getBranchName(receipt.branch_id) }}</td>
        <td class="py-2 px-4">{{ receipt.receipt_number }}</td>
        <td class="py-2 px-4">{{ receipt.receipt_date | date:'MMM d, y' }}</td>
        <td class="py-2 px-4">{{ receipt.amount | currency:'PHP' }}</td>
        <td class="py-2 px-4">{{ receipt.note }}</td>
        <td class="py-2 px-4 text-center">
          <button class="text-blue-500 mr-2" (click)="openModal('view', receipt)">View</button>
          <button class="text-green-500 mr-2" (click)="openModal('edit', receipt)">Edit</button>
          <button class="text-red-500" (click)="deleteReceipt(receipt.id)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="flex justify-between items-center mt-4">
    <button class="px-3 py-1 border rounded" [disabled]="currentPage === 1"
      (click)="currentPage = currentPage - 1">Previous</button>
    <span>Page {{ currentPage }}</span>
    <button class="px-3 py-1 border rounded" [disabled]="currentPage * pageSize >= receipts.length"
      (click)="currentPage = currentPage + 1">Next</button>
  </div>
</div>

<!-- Modal -->
<div *ngIf="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-3xl overflow-y-auto max-h-screen">
    <h3 class="text-lg font-bold mb-4">
      {{ modalMode === 'add' ? 'Add Receipt' : modalMode === 'edit' ? 'Edit Receipt' : 'View Receipt' }}
    </h3>

    <!-- Form Mode -->
    <form *ngIf="modalMode !== 'view'" (ngSubmit)="saveReceipt()" class="space-y-4">

      <!-- Customer -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
        <ng-select [items]="customers" bindLabel="customer_name" bindValue="id"
          [(ngModel)]="selectedReceipt.customer_id" name="customer_id" placeholder="Select customer"
          [clearable]="true" (change)="onCustomerChange($event)"
          [ngClass]="{'border-red-500': formSubmitted && !selectedReceipt.customer_id, 'border-gray-300': !formSubmitted || selectedReceipt.customer_id}">
        </ng-select>
        <div *ngIf="formSubmitted && !selectedReceipt.customer_id" class="text-red-500 text-sm mt-1">
          Customer is required.
        </div>
      </div>

      <!-- Branch -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
        <ng-select [items]="branches" bindLabel="branch_name" bindValue="id"
          [(ngModel)]="selectedReceipt.branch_id" name="branch_id" placeholder="Select branch"
          [clearable]="true"
          [ngClass]="{'border-red-500': formSubmitted && !selectedReceipt.branch_id, 'border-gray-300': !formSubmitted || selectedReceipt.branch_id}">
        </ng-select>
        <div *ngIf="formSubmitted && !selectedReceipt.branch_id" class="text-red-500 text-sm mt-1">
          Branch is required.
        </div>
      </div>

      <!-- Receipt Number -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Official Receipt Number</label>
        <input type="text" [(ngModel)]="selectedReceipt.receipt_number" name="receipt_number"
          class="w-full px-3 py-2 border rounded-md shadow-sm"
          [ngClass]="{'border-red-500': formSubmitted && !selectedReceipt.receipt_number, 'border-gray-300': !formSubmitted || selectedReceipt.receipt_number}">
        <div *ngIf="formSubmitted && !selectedReceipt.receipt_number" class="text-red-500 text-sm mt-1">
          Receipt number is required.
        </div>
      </div>

      <!-- Receipt Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Receipt Date</label>
        <input type="date" [(ngModel)]="selectedReceipt.receipt_date" name="receipt_date"
          class="w-full px-3 py-2 border rounded-md shadow-sm"
          [ngClass]="{'border-red-500': formSubmitted && !selectedReceipt.receipt_date, 'border-gray-300': !formSubmitted || selectedReceipt.receipt_date}">
      </div>

      <!-- Amount -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
        <input type="number" [(ngModel)]="selectedReceipt.amount" name="amount"
          class="w-full px-3 py-2 border rounded-md shadow-sm"
          [ngClass]="{'border-red-500': formSubmitted && !selectedReceipt.amount, 'border-gray-300': !formSubmitted || selectedReceipt.amount}">
        <div *ngIf="formSubmitted && !selectedReceipt.amount" class="text-red-500 text-sm mt-1">
          Amount is required.
        </div>
      </div>

      <!-- Note -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
        <textarea [(ngModel)]="selectedReceipt.note" name="note"
          class="w-full px-3 py-2 border rounded-md shadow-sm"></textarea>
      </div>

      <!-- Payment Details Section -->
      <div class="mt-6">
        <h3 class="font-semibold mb-2">Payment Details</h3>

        <table class="min-w-full border">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-4 text-left">Payment Method</th>
              <th class="py-2 px-4 text-left">Reference #</th>
              <th class="py-2 px-4 text-left">Applied Amount</th>
              <th class="py-2 px-4 text-left">Remarks</th>
              <th class="py-2 px-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let payment of selectedReceipt.payments; let i = index">
              <!-- Payment Method -->
              <td class="py-2 px-4">
                <select [(ngModel)]="payment.method" name="method{{i}}" class="border px-2 py-1 rounded w-full">
                  <option value="" disabled>Select method</option>
                  <option value="cash">Cash</option>
                  <option value="credit_card">Credit Card</option>
                  <option value="check">Check</option>
                  <option value="bank_deposit">Bank Deposit</option>
                </select>
              </td>

              <!-- Reference Number -->
              <td class="py-2 px-4">
                <input type="text" [(ngModel)]="payment.reference" name="reference{{i}}" class="border px-2 py-1 rounded w-full" />
              </td>

              <!-- Applied Amount -->
              <td class="py-2 px-4">
                <input type="number" step="0.01" [(ngModel)]="payment.amount" name="amount{{i}}" class="border px-2 py-1 rounded w-32" />
              </td>

              <!-- Remarks -->
              <td class="py-2 px-4">
                <input type="text" [(ngModel)]="payment.remarks" name="remarks{{i}}" class="border px-2 py-1 rounded w-full" />
              </td>

              <!-- Actions -->
              <td class="py-2 px-4 text-center">
                <button type="button" class="text-red-500" (click)="removePayment(i)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Add Payment Button -->
        <div class="mt-2">
          <button type="button" class="bg-green-500 text-white px-4 py-2 rounded" (click)="addPayment()">
            Add Payment
          </button>
        </div>
      </div>


      <!-- Sales invoices for selected customer -->
      <div *ngIf="invoices.length > 0" class="mt-4">
        <h3 class="font-semibold mb-2">Apply to Sales Invoices</h3>
        <table class="min-w-full border">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-4 text-left">Apply</th>
              <th class="py-2 px-4 text-left">Invoice No</th>
              <th class="py-2 px-4 text-left">Balance</th>
              <th class="py-2 px-4 text-left">Applied Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let inv of invoices">
              <!-- Apply Checkbox -->
              <td class="py-2 px-4">
                <input type="checkbox"
                      [checked]="isApplied(inv.id)"
                      (change)="toggleInvoiceSelection(inv)" />
              </td>

              <!-- Invoice Number -->
              <td class="py-2 px-4">{{ inv.invoice_number }}</td>

              <!-- Balance -->
              <td class="py-2 px-4">{{ inv.balance | number:'1.2-2' }}</td>

              <!-- Applied Amount Input -->
              <td class="py-2 px-4">
                <input type="number"
                      step="0.01"
                      class="border px-2 py-1 rounded w-32"
                      *ngIf="isApplied(inv.id)"
                      [ngModel]="getAppliedInvoice(inv.id)?.applied_amount"
                      (ngModelChange)="updateAppliedAmount(inv.id, $event)" />
                <span *ngIf="!isApplied(inv.id)">-</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>


      <!-- Actions -->
      <div class="flex justify-end space-x-2 pt-4">
        <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-4 py-2 rounded"
          (click)="closeModal()">Cancel</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
          Save
        </button>
      </div>
    </form>

    <!-- View Mode -->
    <div *ngIf="modalMode === 'view'" class="space-y-2">
      <p><strong>Customer:</strong> {{ getCustomerName(selectedReceipt.customer_id) }}</p>
      <p><strong>Branch:</strong> {{ getBranchName(selectedReceipt.branch_id) }}</p>
      <p><strong>Receipt Number:</strong> {{ selectedReceipt.receipt_number }}</p>
      <p><strong>Receipt Date:</strong> {{ selectedReceipt.receipt_date | date:'MMM d, y' }}</p>
      <p><strong>Amount:</strong> {{ selectedReceipt.amount | currency:'PHP' }}</p>
      <p><strong>Note:</strong> {{ selectedReceipt.note }}</p>
      <div class="flex justify-end mt-4">
        <button class="bg-gray-300 px-4 py-2 rounded" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>
